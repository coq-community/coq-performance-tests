LATEXFLAGS?=--synctex=1 --shell-escape
PDFLATEX?=lualatex
MD5?=md5sum
OTHERFLAGS?=

PDFS := all.pdf

EXTRA_TEX :=

include ../Makefile.show

.PHONY: all
all: $(PDFS)

PERF_KINDS_MAKEFILE := ../PerformanceExperiments/Makefile.variables.kinds
include $(PERF_KINDS_MAKEFILE)
EXPERIMENTS_PERF_KINDS := $(subst _,-,$(ALL_KINDS))
EXPERIMENTS_PERF_DATA_MD5 := $(addprefix ../PerformanceExperiments/,$(addsuffix .txt.md5,$(EXPERIMENTS_PERF_KINDS)))
GENERATED_TEX := $(addprefix generated/,$(addsuffix .tex,$(EXPERIMENTS_PERF_KINDS)))

$(GENERATED_TEX) : generated/%.tex : ../PerformanceExperiments/%.txt Makefile generate-tex.py
	$(HIDE)mkdir -p generated
	$(SHOW)'PYTHON GENERATE-TEX $*'
	$(HIDE)$(PYTHON3) ./generate-tex.py $* $< $@ generated/$*-table.txt

generated/all.tex: Makefile $(PERF_KINDS_MAKEFILE)
	$(HIDE)mkdir -p generated
	$(SHOW)'ECHO > $@'
	$(HIDE)echo '$(patsubst %,\include{generated/%},$(EXPERIMENTS_PERF_KINDS))' > $@

SVGS := $(addsuffix .svg,$(subst /,-,$(EXPERIMENTS_PERF_KINDS)) $(EXTRA_TEX))

$(SVGS) : %.svg : all.pdf
	$(SHOW)'PDF2SVG $@'
	$(HIDE)pdf2svg all-$*-figure0.pdf $@ # just use the figure generated by tikzexternalize

$(PDFS): $(EXPERIMENTS_PERF_DATA_MD5) generated/all.tex $(GENERATED_TEX) $(addsuffix .tex,$(EXTRA_TEX)) packages.tex

.PHONY: svg
svg all: $(SVGS)

%.md5: %
	$(MD5) '$<' | awk '{print $$1}' > '$@'

print-errors:
	$(HIDE)for i in *-figure*.log; do \
	  echo '============================'; \
	  echo "$$i"; \
	  echo '============================'; \
	  cat "$$i"; \
	  echo '============================'; \
	done
	false
.PHONY: print-errors

$(PDFS) : %.pdf : %.tex
	$(SHOW)"PDFLATEX"
	$(HIDE)$(PDFLATEX) $(LATEXFLAGS) $(OTHERFLAGS) $< || $(MAKE) print-errors

.PHONY: clean
clean:
	rm -rf *.aux *.out *.nav *.toc *.vrb $(PDFS) *.snm *.log *.bbl *.blg *.tex.d *.run.xml *.atfi *.auxlock *.bcf *-blx.bib *.synctex.gz *'.synctex.gz(busy)' *.synctex *'.synctex(busy)' *.dpth $(SVGS) *.table *.dat *.gnuplot *-figure?.* generated/
