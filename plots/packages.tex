\usepackage{tikz}
\usepackage{pgfplots}
\usepackage{gnuplottex}[2016/08/21]%must be before listings package; min date is for compat with tikzexternalize
\usepackage{pgfkeys}
\usepackage{pgffor}
\usepackage{pgfplotstable}
\pgfplotsset{compat=1.15}
\usepackage{currfile}
\usepackage{filecontents}
\usepackage{xstring}

\makeatletter
\def\@replaceslash#1#2/#3\relax{%
  #2%
  \ifx#3\@empty
  \else
    #1\@replaceslash{#1}#3\relax%
  \fi
}
\def\replaceslash#1#2{\@replaceslash{#1}#2/\relax}
\def\replaceslashdash#1{\replaceslash{-}{#1}}
\newcommand{\StrGobbleBegin}[3]{%
  \StrLen{#2}[\@StrGobbleBegin@Len]%
  \IfBeginWith{#1}{#2}{%
    \StrGobbleLeft{#1}{\@StrGobbleBegin@Len}[#3]%
  }{%
    \edef#3{#1}%
  }%
}
\makeatother

\usepgfplotslibrary{external}
\tikzexternalize
\edef\currfiledirbase{\currfiledir\currfilebase}
\StrGobbleBegin{\currfiledirbase}{generated/}{\currfiledirbaseadjusted}
\edef\currfiledirbasedash{\expandafter\replaceslashdash\expandafter{\currfiledirbaseadjusted}}
\tikzsetfigurename{\tikzexternalrealjob-\currfiledirbasedash-figure}

\usepackage{hyperref}
\usepackage{unicode-math}
\usepackage{amsmath}
\usepackage{newunicodechar}
\newcommand{\newunicodecharpdftex}[2]{\newunicodechar{#1}{\texorpdfstring{#2}{#1}}}
\newunicodecharpdftex{Œë}{\ensuremath{\Alpha}}
\newunicodecharpdftex{Œí}{\ensuremath{\Beta}}
\newunicodecharpdftex{Œì}{\ensuremath{\Gamma}}
\newunicodecharpdftex{Œî}{\ensuremath{\Delta}}
\newunicodecharpdftex{Œï}{\ensuremath{\Epsilon}}
\newunicodecharpdftex{Œñ}{\ensuremath{\Zeta}}
\newunicodecharpdftex{Œó}{\ensuremath{\Eta}}
\newunicodecharpdftex{Œò}{\ensuremath{\Theta}}
\newunicodecharpdftex{Œô}{\ensuremath{\Iota}}
\newunicodecharpdftex{Œö}{\ensuremath{\Kappa}}
\newunicodecharpdftex{Œõ}{\ensuremath{\Lambda}}
\newunicodecharpdftex{Œú}{\ensuremath{\Mu}}
\newunicodecharpdftex{Œù}{\ensuremath{\Nu}}
\newunicodecharpdftex{Œû}{\ensuremath{\Xi}}
\newunicodecharpdftex{Œü}{\ensuremath{\Omicron}}
\newunicodecharpdftex{Œ†}{\ensuremath{\Pi}}
\newunicodecharpdftex{Œ°}{\ensuremath{\Rho}}
\newunicodecharpdftex{Œ£}{\ensuremath{\Sigma}}
\newunicodecharpdftex{Œ§}{\ensuremath{\Tau}}
\newunicodecharpdftex{Œ•}{\ensuremath{\Upsilon}}
\newunicodecharpdftex{Œ¶}{\ensuremath{\Phi}}
\newunicodecharpdftex{Œß}{\ensuremath{\Chi}}
\newunicodecharpdftex{Œ®}{\ensuremath{\Psi}}
\newunicodecharpdftex{Œ©}{\ensuremath{\Omega}}
\newunicodecharpdftex{Œ±}{\ensuremath{\alpha}}
\newunicodecharpdftex{Œ≤}{\ensuremath{\beta}}
\newunicodecharpdftex{Œ≥}{\ensuremath{\gamma}}
\newunicodecharpdftex{Œ¥}{\ensuremath{\delta}}
\newunicodecharpdftex{œµ}{\ensuremath{\epsilon}}
\newunicodecharpdftex{Œµ}{\ensuremath{\varepsilon}}
\newunicodecharpdftex{Œ∂}{\ensuremath{\zeta}}
\newunicodecharpdftex{Œ∑}{\ensuremath{\eta}}
\newunicodecharpdftex{Œ∏}{\ensuremath{\theta}}
\newunicodecharpdftex{œë}{\ensuremath{\vartheta}}
\newunicodecharpdftex{Œπ}{\ensuremath{\iota}}
\newunicodecharpdftex{Œ∫}{\ensuremath{\kappa}}
\newunicodecharpdftex{œ∞}{\ensuremath{\varkappa}}
\newunicodecharpdftex{Œª}{\ensuremath{\lambda}}
\newunicodecharpdftex{Œº}{\ensuremath{\mu}}
\newunicodecharpdftex{ŒΩ}{\ensuremath{\nu}}
\newunicodecharpdftex{Œæ}{\ensuremath{\xi}}
\newunicodecharpdftex{Œø}{\ensuremath{\omicron}}
\newunicodecharpdftex{œÄ}{\ensuremath{\pi}}
\newunicodecharpdftex{œñ}{\ensuremath{\varpi}}
\newunicodecharpdftex{œÅ}{\ensuremath{\rho}}
\newunicodecharpdftex{œ±}{\ensuremath{\varrho}}
\newunicodecharpdftex{œÉ}{\ensuremath{\sigma}}
\newunicodecharpdftex{œÇ}{\ensuremath{\varsigma}}
\newunicodecharpdftex{œÑ}{\ensuremath{\tau}}
\newunicodecharpdftex{œÖ}{\ensuremath{\upsilon}}
\newunicodecharpdftex{œï}{\ensuremath{\phi}}
\newunicodecharpdftex{œÜ}{\ensuremath{\varphi}}
\newunicodecharpdftex{œá}{\ensuremath{\chi}}
\newunicodecharpdftex{œà}{\ensuremath{\psi}}
\newunicodecharpdftex{œâ}{\ensuremath{\omega}}
\newunicodecharpdftex{‚àÄ}{\ensuremath{\forall}}
\newunicodecharpdftex{‚àÉ}{\ensuremath{\exists}}
\newunicodecharpdftex{‚Üí}{\ensuremath{\to}}
\newunicodecharpdftex{‚áí}{\ensuremath{\Rightarrow}}
\newunicodecharpdftex{√ó}{\ensuremath{\times}}
\newunicodecharpdftex{‚àß}{\ensuremath{\wedge}}
\newunicodecharpdftex{‚ä¢}{\ensuremath{\vdash}}
\newunicodecharpdftex{ùîπ}{\ensuremath{\mathbb{B}}}
\newunicodecharpdftex{‚ÑÇ}{\ensuremath{\mathbb{C}}}
\newunicodecharpdftex{‚Ñï}{\ensuremath{\mathbb{N}}}
\newunicodecharpdftex{‚Ñô}{\ensuremath{\mathbb{P}}}
\newunicodecharpdftex{‚Ñö}{\ensuremath{\mathbb{Q}}}
\newunicodecharpdftex{‚Ñù}{\ensuremath{\mathbb{R}}}
\newunicodecharpdftex{‚Ñ§}{\ensuremath{\mathbb{Z}}}
\newunicodecharpdftex{‚Å∞}{\ensuremath{{}^0}}
\newunicodecharpdftex{¬π}{\ensuremath{{}^1}}
\newunicodecharpdftex{¬≤}{\ensuremath{{}^2}}
\newunicodecharpdftex{¬≥}{\ensuremath{{}^3}}
\newunicodecharpdftex{‚Å¥}{\ensuremath{{}^4}}
\newunicodecharpdftex{‚Åµ}{\ensuremath{{}^5}}
\newunicodecharpdftex{‚Å∂}{\ensuremath{{}^6}}
\newunicodecharpdftex{‚Å∑}{\ensuremath{{}^7}}
\newunicodecharpdftex{‚Å∏}{\ensuremath{{}^8}}
\newunicodecharpdftex{‚Åπ}{\ensuremath{{}^9}}
\newunicodecharpdftex{‚ÇÄ}{\ensuremath{{}_0}}
\newunicodecharpdftex{‚ÇÅ}{\ensuremath{{}_1}}
\newunicodecharpdftex{‚ÇÇ}{\ensuremath{{}_2}}
\newunicodecharpdftex{‚ÇÉ}{\ensuremath{{}_3}}
\newunicodecharpdftex{‚ÇÑ}{\ensuremath{{}_4}}
\newunicodecharpdftex{‚ÇÖ}{\ensuremath{{}_5}}
\newunicodecharpdftex{‚ÇÜ}{\ensuremath{{}_6}}
\newunicodecharpdftex{‚Çá}{\ensuremath{{}_7}}
\newunicodecharpdftex{‚Çà}{\ensuremath{{}_8}}
\newunicodecharpdftex{‚Çâ}{\ensuremath{{}_9}}
\newunicodecharpdftex{‚Å∫}{\ensuremath{{}^+}}
\newunicodecharpdftex{‚Åª}{\ensuremath{{}^-}}
\newunicodecharpdftex{‚Åº}{\ensuremath{{}^=}}
\newunicodecharpdftex{‚ÅΩ}{\ensuremath{{}^(}}
\newunicodecharpdftex{‚Åæ}{\ensuremath{{}^)}}
\newunicodecharpdftex{‚Çä}{\ensuremath{{}_+}}
\newunicodecharpdftex{‚Çã}{\ensuremath{{}_-}}
\newunicodecharpdftex{‚Çå}{\ensuremath{{}_=}}
\newunicodecharpdftex{‚Çç}{\ensuremath{{}_(}}
\newunicodecharpdftex{‚Çé}{\ensuremath{{}_)}}

\newunicodecharpdftex{·µÉ}{\ensuremath{{}^{\text{a}}}}
\newunicodecharpdftex{·µá}{\ensuremath{{}^{\text{b}}}}
\newunicodecharpdftex{·∂ú}{\ensuremath{{}^{\text{c}}}}
\newunicodecharpdftex{·µà}{\ensuremath{{}^{\text{d}}}}
\newunicodecharpdftex{·µâ}{\ensuremath{{}^{\text{e}}}}
\newunicodecharpdftex{·∂†}{\ensuremath{{}^{\text{f}}}}
\newunicodecharpdftex{·µç}{\ensuremath{{}^{\text{g}}}}
\newunicodecharpdftex{ ∞}{\ensuremath{{}^{\text{h}}}}
\newunicodecharpdftex{‚Å±}{\ensuremath{{}^{\text{i}}}}
\newunicodecharpdftex{ ≤}{\ensuremath{{}^{\text{j}}}}
\newunicodecharpdftex{·µè}{\ensuremath{{}^{\text{k}}}}
\newunicodecharpdftex{À°}{\ensuremath{{}^{\text{l}}}}
\newunicodecharpdftex{·µê}{\ensuremath{{}^{\text{m}}}}
\newunicodecharpdftex{‚Åø}{\ensuremath{{}^{\text{n}}}}
\newunicodecharpdftex{·µí}{\ensuremath{{}^{\text{o}}}}
\newunicodecharpdftex{·µñ}{\ensuremath{{}^{\text{p}}}}
\newunicodecharpdftex{ ≥}{\ensuremath{{}^{\text{r}}}}
\newunicodecharpdftex{À¢}{\ensuremath{{}^{\text{s}}}}
\newunicodecharpdftex{·µó}{\ensuremath{{}^{\text{t}}}}
\newunicodecharpdftex{·µò}{\ensuremath{{}^{\text{u}}}}
\newunicodecharpdftex{·µõ}{\ensuremath{{}^{\text{v}}}}
\newunicodecharpdftex{ ∑}{\ensuremath{{}^{\text{w}}}}
\newunicodecharpdftex{À£}{\ensuremath{{}^{\text{x}}}}
\newunicodecharpdftex{ ∏}{\ensuremath{{}^{\text{y}}}}
\newunicodecharpdftex{·∂ª}{\ensuremath{{}^{\text{z}}}}
\newunicodecharpdftex{‚Çê}{\ensuremath{{}_{\text{a}}}}
\newunicodecharpdftex{‚Çë}{\ensuremath{{}_{\text{e}}}}
\newunicodecharpdftex{‚Çï}{\ensuremath{{}_{\text{h}}}}
\newunicodecharpdftex{·µ¢}{\ensuremath{{}_{\text{i}}}}
\newunicodecharpdftex{‚±º}{\ensuremath{{}_{\text{j}}}}
\newunicodecharpdftex{‚Çñ}{\ensuremath{{}_{\text{k}}}}
\newunicodecharpdftex{‚Çó}{\ensuremath{{}_{\text{l}}}}
\newunicodecharpdftex{‚Çò}{\ensuremath{{}_{\text{m}}}}
\newunicodecharpdftex{‚Çô}{\ensuremath{{}_{\text{n}}}}
\newunicodecharpdftex{‚Çí}{\ensuremath{{}_{\text{o}}}}
\newunicodecharpdftex{‚Çö}{\ensuremath{{}_{\text{p}}}}
\newunicodecharpdftex{·µ£}{\ensuremath{{}_{\text{r}}}}
\newunicodecharpdftex{‚Çõ}{\ensuremath{{}_{\text{s}}}}
\newunicodecharpdftex{‚Çú}{\ensuremath{{}_{\text{t}}}}
\newunicodecharpdftex{·µ§}{\ensuremath{{}_{\text{u}}}}
\newunicodecharpdftex{·µ•}{\ensuremath{{}_{\text{v}}}}
\newunicodecharpdftex{‚Çì}{\ensuremath{{}_{\text{x}}}}

\newunicodecharpdftex{‚âÖ}{\ensuremath{\cong}}
\newunicodecharpdftex{‚àò}{\ensuremath{\circ}}


% to have the external picture be updated every time the input files are changed
\makeatletter
\newcommand{\einput}[1]{\@@input #1 \space}
\newcommand{\beginTikzpictureStamped}[2][]{%
    {%
        \everyeof{\noexpand}% IDK why \noexpand is the magic one, but I got it from http://mirrors.ibiblio.org/CTAN/macros/latex/contrib/oberdiek/catchfile.pdf
        \long\xdef\@tikzstamp{#2}%
    }%
    \def\@dobegintikzpicture{\begin{tikzpicture}[#1]}%
    \expandafter\@dobegintikzpicture\expandafter\def\expandafter\tikzstamp\expandafter{\@tikzstamp}%
}
\newcommand{\TikzpictureStamped}[3][]{\beginTikzpictureStamped[#1]{#2}#3\end{tikzpicture}}%
\makeatother


\makeatletter
% \addplotfunctionalregression{regression kind}{default settings for a and b, also for x and y columns}{default settings for table}{comma-separated-variable-list}{f(x)}{params for \addplot}{table file}
\newcounter{addplotfunctionalregression@var@count}
\newcommand{\addplotfunctionalregression@tablename}{\jobname-regression.table}
\newcommand{\addplotfunctionalregression@parametersname}{\jobname-parameters.dat}
\newif\iffunctionalregression@boundy
\newcommand{\addplotfunctionalregression}[7]{%
    \begingroup
    \pgfqkeys{/pgfplots/table/create col/#1 regression}{#2}%
    \pgfkeysgetvalue{/pgfplots/table/create col/#1 regression/x}{\pgfplotstable@xsrc}%
    \pgfkeysgetvalue{/pgfplots/table/create col/#1 regression/y}{\pgfplotstable@ysrc}%
%    \pgfkeysgetvalue{/pgfplots/table/create col/#1 regression/bound y}{\pgfplotstable@boundy}%
%    \csname functionalregression@boundy\pgfplotstable@boundy\endcsname
    \def\pgfplotstable@regression@initcode{}%
    \foreach \varname in {#4} {%
      \pgfkeysgetvalue{/pgfplots/table/create col/#1 regression/\varname}{\pgfplotstable@varinit}%
      \xdef\pgfplotstable@regression@initcode{%
        \pgfplotstable@regression@initcode\space
        \varname=\pgfplotstable@varinit;
      }%
    }%
    %\def\pgfplotstable@table{#7}%
    \pgfplotstableread[#3]{#7}{\pgfplotstable@tableinternal}% FIXME
    \def\pgfplotstable@table{\pgfplotstable@tableinternal}%
    \ifx\pgfplotstable@table\pgfutil@empty
          \pgfutil@ifundefined{pgfplotstablename}{}{% query the name of the actual table struct
                \let\pgfplotstable@table=\pgfplotstablename
          }%
    \fi
    \ifx\pgfplotstable@table\pgfutil@empty
          \pgfplots@error{Sorry, I couldn't determine a value for create col/#1 regression/table. Which table should I load?}%
    \fi
    \ifx\pgfplotstable@xsrc\pgfutil@empty
        \pgfplotsifinaddplottablestruct{%
          \pgfutil@ifundefined{pgfplots@plot@tbl@x}{}{%
            \let\pgfplotstable@xsrc=\pgfplots@plot@tbl@x
            \ifx\pgfplotstable@ysrc\pgfutil@empty
              \pgfplotstablegetcolsof\pgfplots@table
              \ifnum\pgfplotsretval=2
              \else
                \pgfplotsthrow{invalid argument}{\pgfplotstable@ysrc}{Sorry, I don't which column should be used as `y' for the #1 regression. Please provide '#1 regression={y=<colname>}'}\pgfeov%
              \fi
            \fi
          }%
        }{}%
    \fi
    \ifx\pgfplotstable@xsrc\pgfutil@empty
            \def\pgfplotstable@xsrc{[index]0}%
    \fi
    \ifx\pgfplotstable@ysrc\pgfutil@empty
            \def\pgfplotstable@ysrc{[index]1}%
    \fi
    \bgroup
      \edef\dosavetable{\noexpand\pgfplotstablesave[
          col sep=comma,
          columns={\pgfplotstable@xsrc,\pgfplotstable@ysrc},
        ]{\expandafter\unexpanded\expandafter{\pgfplotstable@table}}{\addplotfunctionalregression@tablename}%
      }%
      \dosavetable
      \everyeof{\noexpand}%
      \def\par{^^J}%
      \obeylines
      \makeatletter
      \xdef\pgfplotstable@gnu@table{\@@input \addplotfunctionalregression@tablename\space}%
    \egroup
    \xdef\pgfplotstable@gnu@code{%
        f(x) = #5;     % Define the function to fit
        % Set reasonable starting values here
        \pgfplotstable@regression@initcode\space
        set datafile separator ",";
        $Mydata << EOD^^J%
        \pgfplotstable@gnu@table^^J%
        EOD^^J
        fit f(x) $Mydata u 1:2 via #4; % Select the file
        stats $Mydata u 1:2;
        plot [x=STATS_min_x:STATS_max_x]\iffunctionalregression@boundy[STATS_min_y:STATS_max_y]\fi f(x);    % Specify the range to plot
        set print "\addplotfunctionalregression@parametersname";  % Open a file to save the parameters
        print #4;                  % Write the parameters to file
    }%
    \addplot [#6] gnuplot [raw gnuplot] {\pgfplotstable@gnu@code}; % allows arbitrary gnuplot commands
    \pgfplotstableread{\addplotfunctionalregression@parametersname}\parameters % Open the file Gnuplot wrote
    \setcounter{addplotfunctionalregression@var@count}{0}%
    \foreach \varname in {#4} {%
      \pgfplotstablegetelem{0}{\arabic{addplotfunctionalregression@var@count}}\of\parameters
      \expandafter\xdef\csname pgfplotstableregression\varname\endcsname{\pgfplotsretval}
      \stepcounter{addplotfunctionalregression@var@count}%
    }%
    \endgroup
}
% \addplot<kind>regression[params for \addplot][default settings for a and b, also for x and y columns][table parameters]{table file}
% \pgfplotstablenewregression{regression name}{comma-separated variable list}{function}
\newcommand{\pgfplotstablenewregression}[3]{%
  \expandafter\NewDocumentCommand\csname addplot#1regression\endcsname{ O{no markers} O{} O{} m}{%
      \addplotfunctionalregression{#1}%
          {##2}%
          {##3}%
          {#2}%
          {#3}%
          {##1}%
          {##4}%
  }
  \pgfkeys{%
%        /pgfplots/table/create col/#1 regression/.code={%
%                \pgfplotstable@#1@regression{#1}%
%                \pgfkeysalso{/pgfplots/table/create col/@from list struct=\pgfplotsretval}%
%        },
        /pgfplots/table/create col/#1 regression/.default=,%
        /pgfplots/table/create col/#1 regression/x/.initial=,%
        /pgfplots/table/create col/#1 regression/y/.initial=,%
        /pgfplots/table/create col/#1 regression/bound y/.is if=functionalregression@boundy,
        /pgfplots/table/create col/#1 regression/table/.initial=,%
        %/pgfplots/table/create col/#1 regression/variance/.initial=,%
        %/pgfplots/table/create col/#1 regression/variance list/.initial=,%
        %/pgfplots/table/create col/#1 regression/variance src/.initial=,%
        %/pgfplots/table/create col/#1 regression/xmode/.initial=,% auto
        %/pgfplots/table/create col/#1 regression/ymode/.initial=,% auto
  }
  \bgroup % cf https://tex.stackexchange.com/a/15263/2066
    \globaldefs=1\relax
    \foreach \varname in {#2} {%
      \pgfkeys{%
        /pgfplots/table/create col/#1 regression/\varname/.initial=1%
      }%
    }
  \egroup
}


%% exponential regression fit
% \addplotexponentialregression[params for \addplot][default settings for a and b, also for x and y columns][table parameters]{table file}
\pgfplotstablenewregression{exponential}{a,b}{a*exp(b*x)}
% \addplotquadraticregression[params for \addplot][default settings for a and b and c, also for x and y columns][table parameters]{table file}
\pgfplotstablenewregression{quadratic}{a,b,c}{a*x**2+b*x+c}
% \addplotcubicregression[params for \addplot][default settings for a and b and c and d, also for x and y columns][table parameters]{table file}
\pgfplotstablenewregression{cubic}{a,b,c,d}{a*x**3+b*x**2+c*x+d}
% regress on y = a (x!)
% \addplotfactorialregression[params for \addplot][default settings for a, also for x and y columns][table parameters]{table file}
\pgfplotstablenewregression{factorial}{a}{a*gamma(x+1)}
\makeatother
